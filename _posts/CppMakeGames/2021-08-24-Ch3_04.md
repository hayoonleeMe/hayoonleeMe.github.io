---
title: "C++ Games Chapter3_4 íŒŒí‹°í´ ì‹œìŠ¤í…œ Particle System"
excerpt: "íŒŒí‹°í´ ì‹œìŠ¤í…œ Particle System"
categories:
  - Cpp MakeGames
tags:
  - Cpp
last_modified_at: 2021-08-24
toc: true
toc_sticky: true
toc_label: "ëª©ì°¨ğŸ‘€"
---

<pre>ë³¸ í•„ê¸°ëŠ” ì¸í”„ëŸ°ì˜ í™ì •ëª¨ êµìˆ˜ë‹˜ì˜ ê°•ì˜ì¸ <b>í™ì •ëª¨ì˜ ê²Œì„ ë§Œë“¤ê¸° ì—°ìŠµ ë¬¸ì œ íŒ¨í‚¤ì§€</b> ë¥¼ ë“£ê³  ì‘ì„±í•©ë‹ˆë‹¤.</pre>{: .notice--success}

### íŒŒí‹°í´ ì‹œìŠ¤í…œ Particle System
íŒŒí‹°í´ ì‹œìŠ¤í…œì´ë€, ì—¬ëŸ¬ê°€ì§€ ì…ìë“¤ì„ ì´ìš©í•´ì„œ ë³µì¡í•´ë³´ì´ëŠ” ì‹œê°íš¨ê³¼ë¥¼ ë§Œë“¤ì–´ ë‚´ëŠ” ê²ƒì´ë‹¤.

**ê¸°ë³¸ ì½”ë“œ**
```cpp
#include "Game2D.h"
#include "Examples/PrimitivesGallery.h"
#include "RandomNumberGenerator.h"
#include "RigidCircle.h"
#include <vector>
#include <memory>

namespace jm
{
    using namespace std;

    static const auto gravity = vec2(0.0f, -9.8f);

    class Particle
    {
    public:
        vec2 pos;
        vec2 vel;
        RGB  color;

        void update(const float & dt)
        {
            const auto acc = gravity; //assumes GA only.

            vel += acc * dt;
            pos += vel * dt;

            // update age.
            // update color (blend with background color)
        }
    };

    class ParticleSystem
    {
    public:
        vector<Particle> particles;		// ê²½ìš°ì— ë”°ë¼ Particle ì˜ í¬ì¸í„°ë¥¼ ë„£ê¸°ë„ í•œë‹¤.

        RandomNumberGenerator rn;

        ParticleSystem()
        {
            reset();
        }

        auto getRandomUnitVector()
        {
            const float theta = rn.getFloat(0.0f, 3.141592f * 2.0f); // 0.0 ~ 2pi

            return vec2{cos(theta), -sin(theta)};
        }

        auto getRandomColor()
        {
            return RGB{ rn.getFloat(0.0f, 1.0f), rn.getFloat(0.0f, 1.0f), rn.getFloat(0.0f, 1.0f) };
        }

        void reset()
        {
            particles.clear();

            // initialize particles
            for (int i = 0; i < 1000; ++i)
            {
                Particle new_particle;
                new_particle.pos = vec2(0.0f, 0.5f) + getRandomUnitVector() * rn.getFloat(0.001f, 0.03f);
                new_particle.vel = getRandomUnitVector() * rn.getFloat(0.01f, 2.0f);
                new_particle.color = getRandomColor();

                particles.push_back(new_particle);
            }
        }

        void update(const float & dt)
        {
            for (auto & pt : particles)
            {
                pt.update(dt);

                // remove particles when they are 1. too old, 2. out of screen.
            }
        }

        void draw()
        {
            beginTransformation();

            for (const auto & pt : particles)
            {
                // Particle í´ë˜ìŠ¤ì—ì„œ draw í•˜ëŠ” ë°©ë²•ë„ ìˆì§€ë§Œ ì¶”í›„ì— ê·¸ë˜í”½ìŠ¤ í˜¹ì€ GPU ê°€ì†ì— ëŒ€í•´ ë” ê³µë¶€í•œë‹¤ë©´
                // ê·¸ë•ŒëŠ” GPU ë¡œ ë°ì´í„°ë¥¼ ë³´ë‚¼ ë•Œ  Particle ì„ í•˜ë‚˜í•˜ë‚˜ê·¸ë¦¬ëŠ” í•¨ìˆ˜ë¥¼ ì—¬ëŸ¬ë²ˆ í˜¸ì¶œí•˜ëŠ” ê²ƒë³´ë‹¤ 
                // ì—¬ëŸ¬ê°œë¥¼ í•œë²ˆì— GPU ë¡œ ë³´ë‚´ì„œ ê·¸ë¦¬ë¼ê³  ëª…ë ¹í•˜ëŠ” ê²ƒì´ í›¨ì”¬ íš¨ìœ¨ì ì´ë‹¤.
                // ë³¸ ì˜ˆì œì—ì„œëŠ” ì„±ëŠ¥ì°¨ì´ê°€ í¬ì§€ ì•Šë‹¤.
                drawPoint(pt.color, pt.pos, 3.0f);	
            }

            endTransformation();
        }
    };

    class Example : public Game2D
    {
    public:
        ParticleSystem ps;

        Example()
            : Game2D()
        {
            reset();
        }

        void reset()
        {
            ps.reset();
        }

        void update() override
        {
            const float dt = getTimeStep() * 0.4f;

            ps.update(dt);

            ps.draw();

            // reset button
            if (isKeyPressedAndReleased(GLFW_KEY_R)) reset();
        }

    };
}

int main(void)
{
    jm::Example().run();

    return 0;
}
```

#### ìˆ˜ëª…ê³¼ alpha-blending
ì¢€ ë” ê°œì„ í•˜ê¸° ìœ„í•´ì„œ Particle System ì— ë¼ì´í”„ë¥¼ ì¶”ê°€í•œë‹¤.    
ë³´í†µ íŒŒí‹°í´ë“¤ì´ ìˆ˜ëª…ì„ ê°–ê³  ìˆ˜ëª…ì´ ë‹¤í•˜ë©´ ì£½ë„ë¡ í•œë‹¤.    
ë˜í•œ íŒŒí‹°í´ì´ ê°‘ìê¸° ì§€ì›Œì§€ë©´ ë¶€ìì—°ìŠ¤ëŸ½ê¸° ë•Œë¬¸ì— ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ ë°°ê²½ì˜ ìƒ‰ê³¼ ì ì  ë¹„ìŠ·í•´ì§€ê²Œ blending ì„ í•´ì¤€ë‹¤.

```cpp
class Particle
{
public:
    vec2 pos;
    vec2 vel;
    RGB  color;

    float age;
    float life;

    void update(const float & dt)
    {
        const auto acc = gravity; //assumes GA only.

        vel += acc * dt;
        pos += vel * dt;

        // update age.
        age += dt;      // ì‹œê°„ì´ ê°ˆìˆ˜ë¡ ë‚˜ì´ë¥¼ ë¨¹ëŠ—ë‚˜.

        // update color (blend with background color)
    }
};

class ParticleSystem
{
public:
    vector<Particle> particles;		// ê²½ìš°ì— ë”°ë¼ Particle ì˜ í¬ì¸í„°ë¥¼ ë„£ê¸°ë„ í•œë‹¤.

    RandomNumberGenerator rn;

    ParticleSystem()
    {
        reset();
    }

    auto getRandomUnitVector()
    {
        const float theta = rn.getFloat(0.0f, 3.141592f * 2.0f); // 0.0 ~ 2pi

        return vec2{cos(theta), -sin(theta)};
    }

    auto getRandomColor()
    {
        return RGB{ rn.getFloat(0.0f, 1.0f), rn.getFloat(0.0f, 1.0f), rn.getFloat(0.0f, 1.0f) };
    }

    void reset()
    {
        particles.clear();

        // initialize particles
        for (int i = 0; i < 1000; ++i)
        {
            Particle new_particle;
            new_particle.pos = vec2(0.0f, 0.5f) + getRandomUnitVector() * rn.getFloat(0.001f, 0.03f);
            new_particle.vel = getRandomUnitVector() * rn.getFloat(0.01f, 2.0f);
            new_particle.color = getRandomColor();
            new_particle.age = 0.0f;        // ë‚˜ì´ì™€ ìˆ˜ëª…ì„ ì´ˆê¸°í™”í•´ì¤€ë‹¤.
            new_particle.life = rn.getFloat(0.1f, 0.5f);

            particles.push_back(new_particle);
        }
    }

    void update(const float & dt)
    {
        for (auto & pt : particles)
        {
            pt.update(dt);

            // remove particles when they are 1. too old, 2. out of screen.
        }
    }

    void draw()
    {
        beginTransformation();

        for (const auto & pt : particles)
        {
            if (pt.age > pt.life) continue;

            const float alpha = 1.0f - pt.age / pt.life; // alpha : ë‚¨ì€ ìˆ˜ëª…ì´ ì–¼ë§ˆë‚˜ ë˜ëŠ”ì§€ë¥¼ 0ì—ì„œ 1ì‚¬ì´ë¡œ í‘œí˜„í•œë‹¤.

            
            const RGB blended_color = { pt.color.r * alpha + 1.0f * (1.0f - alpha), 
                                        pt.color.g * alpha + 1.0f * (1.0f - alpha), 
                                        pt.color.b * alpha + 1.0f * (1.0f - alpha) };

            drawPoint(blended_color, pt.pos, 3.0f);
        }

        endTransformation();
    }
};
```
ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ alpha ëŠ” 0ì— ê°€ê¹Œì›Œì§€ê¸° ë•Œë¬¸ì— ê¸°ë³¸ ë°°ê²½ìƒ‰ì¸ 1,1,1 ì— ê°€ê¹Œì›Œì§„ë‹¤.    
ì´ë¥¼ ë³´í†µ alpha-blending ì´ë¼ í•œë‹¤.
 

#### íŒŒí‹°í´ì˜ ëª¨ì–‘ì„ ë³€ê²½í•˜ê³  íšŒì „ ê¸°ëŠ¥ ì¶”ê°€í•˜ê¸°
```cpp
class Particle
{
public:
    vec2 pos;
    vec2 vel;			// íšŒì „ì„ í¬í•¨í•˜ì§€ ì•ŠëŠ” ì†ë„ì´ê¸° ë•Œë¬¸ì— linear velocity ì„ í˜• ì†ë„ë¼ê³ ë„ í•œë‹¤.
    RGB  color;

    float rot;
    float angular_velocity;	// íšŒì „ ì†ë„, rot ê³¼ angular_velocity ì˜ ê´€ê³„ëŠ” pos-vel ì˜ ê´€ê³„ì™€ ê°™ë‹¤.
                            // ë™ì¼í•˜ê²Œ angular_acceleration ë„ ì¡´ì¬í•œë‹¤.

    float age;
    float life;

    void update(const float & dt)
    {
        const auto acc = gravity; //assumes GA only.

        vel += acc * dt;
        pos += vel * dt;

        rot += angular_velocity * dt;

        // update age.
        age += dt;

        // update color (blend with background color)
    }
};

class ParticleSystem
{
public:
    vector<Particle> particles;		// ê²½ìš°ì— ë”°ë¼ Particle ì˜ í¬ì¸í„°ë¥¼ ë„£ê¸°ë„ í•œë‹¤.

    RandomNumberGenerator rn;

    ParticleSystem()
    {
        reset();
    }

    auto getRandomUnitVector()
    {
        const float theta = rn.getFloat(0.0f, 3.141592f * 2.0f); // 0.0 ~ 2pi

        return vec2{cos(theta), -sin(theta)};
    }

    auto getRandomColor()
    {
        return RGB{ rn.getFloat(0.0f, 1.0f), rn.getFloat(0.0f, 1.0f), rn.getFloat(0.0f, 1.0f) };
    }

    void reset()
    {
        particles.clear();

        // initialize particles
        for (int i = 0; i < 1000; ++i)
        {
            Particle new_particle;
            new_particle.pos = vec2(0.0f, 0.5f) + getRandomUnitVector() * rn.getFloat(0.001f, 0.03f);
            new_particle.vel = getRandomUnitVector() * rn.getFloat(0.01f, 2.0f);
            new_particle.color = getRandomColor();
            new_particle.age = 0.0f;
            new_particle.life = rn.getFloat(0.1f, 0.5f);
            new_particle.rot = rn.getFloat(0.0f, 360.0f);
            new_particle.angular_velocity = rn.getFloat(-1.0f, 1.0f) * 360.0f * 4.0f;

            particles.push_back(new_particle);
        }
    }

    void update(const float & dt)
    {
        for (auto & pt : particles)
        {
            pt.update(dt);

            // remove particles when they are 1. too old, 2. out of screen.
        }
    }

    void draw()
    {
        for (const auto & pt : particles)
        {
            if (pt.age > pt.life) continue;

            const float alpha = 1.0f - pt.age / pt.life; // alpha : ë‚¨ì€ ìˆ˜ëª…ì´ ì–¼ë§ˆë‚˜ ë˜ëŠ”ì§€ë¥¼ 0ì—ì„œ 1ì‚¬ì´ë¡œ í‘œí˜„í•œë‹¤.

            // ì‹œê°„ì´ ì§€ë‚ ìˆ˜ë¡ alpha ëŠ” 0ì— ê°€ê¹Œì›Œì§€ê¸° ë•Œë¬¸ì— ê¸°ë³¸ ë°°ê²½ìƒ‰ì¸ 1,1,1 ì— ê°€ê¹Œì›Œì§„ë‹¤. - alpha blending
            const RGB blended_color = { pt.color.r * alpha + 1.0f * (1.0f - alpha),
                                        pt.color.g * alpha + 1.0f * (1.0f - alpha),
                                        pt.color.b * alpha + 1.0f * (1.0f - alpha) };

            beginTransformation();
            translate(pt.pos);
            rotate(pt.rot);
            drawFilledStar(blended_color, 0.03f, 0.01f);
            endTransformation();
        }
    }
};
```
ì´ˆê¸° íšŒì „ê°ë„ì™€ íšŒì „ì†ë„ë¥¼ ëœë¤ìœ¼ë¡œ ì„¤ì •í•œë‹¤.

<pre>info notice :
2ì°¨ì›ì—ì„œì˜ íšŒì „ì€ 1 ììœ ë„(ì–´ë–¤ ë°©í–¥ìœ¼ë¡œ ì›€ì§ì¼ ìˆ˜ ìˆëŠ”ê°€)ë¥¼ ê°–ëŠ”ë‹¤.
(ë°˜ì‹œê³„ë°©í–¥ íšŒì „ì€ ì‹œê³„ë°©í–¥ì˜ ìŒìˆ˜ ê°ë„ë§Œí¼ íšŒì „í•œ ê²ƒì´ë¼ê³  ë³¼ ìˆ˜ìˆê¸° ë•Œë¬¸ì— ë‘ ê²½ìš°ë¥¼ ëª¨ë‘ ê³ ë ¤í•´ë„ 1 ììœ ë„ì´ë‹¤.)
í•˜ì§€ë§Œ 3ì°¨ì›ì—ì„œì˜ íšŒì „ì€ 3 ììœ ë„ë¡œ ëŠ˜ì–´ë‚œë‹¤. 
ë˜í•œ angular_velocity íšŒì „ ì†ë„ ë˜í•œ ë²¡í„°ë¡œ í‘œí˜„ëœë‹¤.</pre>{: .notice--warning}

<pre>ë³¸ ë¸”ë¡œê·¸ëŠ” ê°œì¸ ê³µë¶€ ê¸°ë¡ì˜ ëª©ì ì„ ê°€ì§‘ë‹ˆë‹¤. í¬ìŠ¤íŠ¸ì˜ ë‚´ìš©ì€ ì–¸ì œë“ ì§€ ë°”ë€” ìˆ˜ ìˆìŠµë‹ˆë‹¤.</pre>{: .notice--info}